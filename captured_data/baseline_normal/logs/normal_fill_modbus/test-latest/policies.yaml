# ===================================================================
# Enhanced policies.yaml for Context-Aware ICS IDS (Aligned with detect2.py + VLAN integration)
# ===================================================================

network:
  plc_ip: '10.10.10.10'
  hmi_ip: '10.10.20.30'

  ip_whitelist_rule:
    id: R012
    description: "Device spoofing attempt from an unauthorized IP address"
    severity: high
    mitre: { tactic: TA0007, technique: T0812 }
    real_world: "Impersonation attacks"
    nis2_article: "Article 23"
    allowed_src_ips: ["10.10.20.30"]

  network_segmentation_rule:
    id: R004
    description: "A device communicated on an incorrect VLAN"
    severity: critical
    mitre: { tactic: TA0007, technique: T0812 }
    real_world: "VLAN Hopping, Network Misconfiguration"
    nis2_article: "Article 21"
    ip_to_vlan_map:
      '10.10.10.10': 10
      '10.10.20.30': 20

protocol:
  function_code_rule:
    id: R006
    description: "Illegal or disallowed Modbus function code used"
    severity: high
    mitre: { tactic: TA0007, technique: T0812 }
    real_world: "Protocol abuse, fuzzing"
    nis2_article: "Article 23"
    allowed_codes: [1, 3, 4, 5, 6]

global_rules:
  - id: R003
    description: "Replay attack detected (same TID and value repeated)"
    severity: medium
    mitre: { tactic: TA0008, technique: T0815 }
    real_world: "Stuxnet"
    nis2_article: "Article 23"
    detection_type: "replay"
    time_window_seconds: 2
    count: 3

  - id: R007
    description: "Network flooding or scanning detected"
    severity: medium
    mitre: { tactic: TA0007, technique: T0812 }
    real_world: "Denial of Service precursor"
    nis2_article: "Article 23"
    detection_type: "flood"
    flood_threshold: 20
    flood_window_seconds: 5

  - id: R013
    description: "Excessive start commands issued in a short period"
    severity: medium
    mitre: { tactic: TA0006, technique: T0831 }
    real_world: "Command abuse"
    nis2_article: "Article 23"
    detection_type: "value_frequency"
    role: "start_cmd"
    value: 500
    max_occurrences: 5
    time_window_seconds: 60

registers:
  - address: 100
    name: 'TankLevel'
    max_rate_of_change: 10.0
    rules:
      - id: R002
        description: "Forged tank level reading exceeds physical maximum"
        severity: high
        mitre: { tactic: TA0007, technique: T0812 }
        real_world: "Maroochy attack"
        nis2_article: "Article 21.b"
        max_value: 80

  - address: 1024
    name: 'start_cmd'
    rules:
      - id: R001
        description: "Unauthorized write to start_cmd register"
        severity: high
        mitre: { tactic: TA0006, technique: T0831 }
        real_world: "Triton (2017)"
        nis2_article: "Article 23"

state_machine:
  state_logic_rule:
    id: R008
    description: "Process state mismatch - command is invalid in the current state"
    severity: high
    mitre: { tactic: TA0007, technique: T0812 }
    real_world: "Logic abuse"
    nis2_article: "Article 21"

  states:
    - state_name: 'IDLE'
      coil_pattern: [false, false, false, false, false, false, false, false]
      valid_commands:
        - { func: 6, addr: 1024, value: 500 }

    - state_name: 'FILLING'
      coil_pattern: [true, false, false, false, false, false, false, false]
      valid_commands:
        - { func: 6, addr: 1024, value: 100 }

    - state_name: 'PAUSED_DURING_FILL'
      coil_pattern: [false, true, false, false, true, false, false, false]
      valid_commands:
        - { func: 6, addr: 1024, value: 400 }

    - state_name: 'DISPENSING'
      coil_pattern: [false, false, true, false, false, false, false, false]
      valid_commands:
        - { func: 6, addr: 1024, value: 100 }

    - state_name: 'PAUSED_DURING_DISPENSE'
      coil_pattern: [false, false, false, false, true, false, false, false]
      valid_commands:
        - { func: 6, addr: 1024, value: 400 }

multi_stage_rule:
  id: R011
  description: "Multi-stage attack: start_cmd + replay + alarm suppression"
  rule_ids: [R001, R003, R005]
  severity: critical
  mitre: { tactic: TA0008, technique: T0815 }
  real_world: "Stuxnet"
  nis2_article: "Article 23"

